name: ci
on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  Run-WEPP:
    name: Deploy Job
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.x

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          key: ${{ github.ref }}-${{ matrix.os }}
          path: .cache

      # --- LINUX SETUP ---
      - name: Install Dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt update
          sudo apt-get install -y wget curl build-essential python3-pandas pkg-config zip cmake libtbb-dev libprotobuf-dev protobuf-compiler openmpi-bin libopenmpi-dev libboost-all-dev
          
          # Install Conda
          wget -O Miniforge3.sh "https://github.com/conda-forge/miniforge/releases/download/24.11.3-2/Miniforge3-24.11.3-2-Linux-x86_64.sh"
          bash Miniforge3.sh -b -p "${HOME}/conda"
          echo "${HOME}/conda/bin" >> $GITHUB_PATH

      # --- MACOS SETUP ---
      - name: Install Dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          # Optimize Homebrew: Skip auto-update to prevent timeouts/errors
          export HOMEBREW_NO_AUTO_UPDATE=1
          export HOMEBREW_NO_INSTALL_CLEANUP=1
          
          # Install libraries
          # We use '|| true' on link steps to prevent errors if they are already linked
          brew install wget curl cmake protobuf tbb open-mpi boost
          
          # Install Conda
          if [[ $(uname -m) == 'arm64' ]]; then
             MINIFORGE_FILE="Miniforge3-24.11.3-2-MacOSX-arm64.sh"
          else
             MINIFORGE_FILE="Miniforge3-24.11.3-2-MacOSX-x86_64.sh"
          fi
          
          wget -O Miniforge3.sh "https://github.com/conda-forge/miniforge/releases/download/24.11.3-2/${MINIFORGE_FILE}"
          bash Miniforge3.sh -b -p "${HOME}/conda"
          echo "${HOME}/conda/bin" >> $GITHUB_PATH

      - name: Install Common Python Libs
        run: |
          pip install snakemake pandas

      # --- COMPILE STEP ---
      - name: Compile C++ Code
        run: |
          mkdir -p build
          cd build
          
          # Set explicit path for CMake to find Boost on macOS
          if [[ "$RUNNER_OS" == "macOS" ]]; then
             BOOST_ROOT=$(brew --prefix boost)
             CMAKE_ARGS="-DBOOST_ROOT=${BOOST_ROOT} -DBoost_INCLUDE_DIR=${BOOST_ROOT}/include"
          fi
          
          # Configure and Build
          cmake $CMAKE_ARGS ..
          make -j2

      - name: Run WEPP
        run: |
          run-wepp() {
              snakemake -s "$GITHUB_WORKSPACE/workflow/Snakefile" "$@"
          }
          export -f run-wepp

          run-wepp help --cores 1 --use-conda --conda-frontend mamba