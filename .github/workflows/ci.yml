name: ci
on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  Run-WEPP:
    name: Deploy Job
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.x

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          key: ${{ github.ref }}-${{ matrix.os }}
          path: .cache

      # --- LINUX SETUP ---
      - name: Install Dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt update
          sudo apt-get install -y wget curl build-essential python3-pandas pkg-config zip cmake libtbb-dev libprotobuf-dev protobuf-compiler
          
          # Install Conda
          wget -O Miniforge3.sh "https://github.com/conda-forge/miniforge/releases/download/24.11.3-2/Miniforge3-24.11.3-2-Linux-x86_64.sh"
          bash Miniforge3.sh -b -p "${HOME}/conda"
          echo "${HOME}/conda/bin" >> $GITHUB_PATH

      # --- MACOS SETUP ---
      - name: Install Dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          # 1. Install System Libraries via Homebrew (The "Good" TBB)
          brew install wget curl cmake protobuf tbb
          
          # 2. Install Conda (For runtime dependencies)
          if [[ $(uname -m) == 'arm64' ]]; then
             MINIFORGE_FILE="Miniforge3-24.11.3-2-MacOSX-arm64.sh"
          else
             MINIFORGE_FILE="Miniforge3-24.11.3-2-MacOSX-x86_64.sh"
          fi
          wget -O Miniforge3.sh "https://github.com/conda-forge/miniforge/releases/download/24.11.3-2/${MINIFORGE_FILE}"
          bash Miniforge3.sh -b -p "${HOME}/conda"
          echo "${HOME}/conda/bin" >> $GITHUB_PATH

      - name: Install Common Python Libs
        run: |
          pip install snakemake pandas

      # --- THE FIX: COMPILE MANUALLY ---
      # We build the binary using the System TBB (installed via apt/brew).
      # Because we do this OUTSIDE of Snakemake, it uses the correct libraries.
      - name: Compile C++ Code
        run: |
          mkdir -p build
          cd build
          
          # Configure CMake (It will find the System TBB)
          cmake ..
          
          # Build the binaries
          make -j2
          
          # Ensure binaries are where Snakemake expects them.
          # (Modify this copy command if your Snakefile expects binaries in a specific folder, e.g. 'bin/')
          # cp wepp ../bin/ || true

      # --- RUN PIPELINE ---
      - name: Run WEPP
        run: |
          run-wepp() {
              snakemake -s "$GITHUB_WORKSPACE/workflow/Snakefile" "$@"
          }
          export -f run-wepp

          # When Snakemake runs, it will see the binary is already built and SKIP the compile step.
          # This allows the rest of the pipeline (like Usher) to run in Conda without crashing the build.
          run-wepp help --cores 1 --use-conda --conda-frontend mamba
